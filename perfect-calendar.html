<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perfect Infinite Calendar - Grid Aligned with Journal Integration</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            background: #f8fafc;
            overflow: hidden;
            height: 100vh;
            color: #1a202c;
        }
        
        .infinite-calendar {
            display: flex;
            height: 100vh;
            width: 100%;
        }

        /* Left Panel - Calendar */
        .calendar-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: white;
            border-right: 1px solid #e2e8f0;
            position: relative;
        }

        .calendar-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            z-index: 100;
            position: relative;
        }

        .current-month {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
            letter-spacing: -0.5px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .current-month:hover {
            transform: scale(1.05);
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .current-date {
            font-size: 16px;
            opacity: 0.9;
            font-weight: 400;
        }

        /* Navigation Controls */
        .nav-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 12px;
            gap: 12px;
        }

        .nav-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.2s ease;
            backdrop-filter: blur(10px);
        }

        .nav-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
        }

        .view-toggle {
            display: flex;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 4px;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .toggle-btn {
            background: transparent;
            border: none;
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .toggle-btn.active {
            background: rgba(255, 255, 255, 0.9);
            color: #667eea;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .quick-nav {
            display: flex;
            gap: 8px;
        }

        /* PERFECT GRID SYSTEM - Week-aligned calendar */
        .weekdays-header {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            background: linear-gradient(135deg, #f7fafc, #edf2f7);
            border-bottom: 2px solid #e2e8f0;
            padding: 16px 0;
            position: sticky;
            top: 0;
            z-index: 50;
        }

        .weekday {
            text-align: center;
            font-size: 13px;
            font-weight: 700;
            color: #4a5568;
            text-transform: uppercase;
            letter-spacing: 1px;
            padding: 8px;
            background: linear-gradient(135deg, #e2e8f0, #cbd5e0);
            margin: 0 1px;
            border-radius: 8px;
        }

        .calendar-viewport {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
            scroll-behavior: smooth;
            position: relative;
        }

        .calendar-viewport::-webkit-scrollbar {
            width: 8px;
        }

        .calendar-viewport::-webkit-scrollbar-track {
            background: #f1f5f9;
        }

        .calendar-viewport::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #cbd5e0, #a0aec0);
            border-radius: 4px;
        }

        .calendar-viewport::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #a0aec0, #718096);
        }

        .calendar-content {
            position: relative;
            padding: 0;
        }

        .month-block {
            border-bottom: 3px solid #e2e8f0;
            background: white;
            margin-bottom: 8px;
        }

        .month-header {
            background: linear-gradient(135deg, #f8fafc, #edf2f7);
            padding: 20px;
            border-bottom: 2px solid #e2e8f0;
            font-weight: 700;
            font-size: 18px;
            color: #2d3748;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 40;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* PERFECT CALENDAR GRID - Always 6 weeks, properly aligned */
        .days-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            grid-template-rows: repeat(6, 1fr);
            gap: 1px;
            background: #e2e8f0;
            padding: 1px;
        }

        .day-cell {
            background: white;
            position: relative;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            padding: 12px 8px;
            min-height: 100px;
            border: 1px solid transparent;
        }

        .day-cell:hover {
            background: linear-gradient(135deg, #f7fafc, #edf2f7);
            transform: scale(1.02);
            z-index: 10;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            border-color: #cbd5e0;
        }

        /* Other month days (grayed out but properly positioned) */
        .day-cell.other-month {
            background: #f8fafc;
            color: #a0aec0;
            opacity: 0.6;
        }

        .day-cell.other-month:hover {
            background: #f1f5f9;
            opacity: 0.8;
        }

        /* Today highlighting */
        .day-cell.today {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            font-weight: 700;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .day-cell.today:hover {
            background: linear-gradient(135deg, #5a6fd8, #6b46c1);
        }

        /* Days with journal entries */
        .day-cell.has-entry {
            background: linear-gradient(135deg, #48bb78, #38a169);
            color: white;
            font-weight: 600;
        }

        .day-cell.has-entry:hover {
            background: linear-gradient(135deg, #38a169, #2f855a);
        }

        /* Selected day */
        .day-cell.selected {
            background: linear-gradient(135deg, #ed8936, #dd6b20) !important;
            color: white;
            box-shadow: 0 0 0 3px rgba(237, 137, 54, 0.3);
            font-weight: 700;
        }

        .day-number {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 6px;
            text-align: center;
        }

        .day-cell.today .day-number,
        .day-cell.has-entry .day-number,
        .day-cell.selected .day-number {
            color: white;
        }

        .entry-preview {
            font-size: 11px;
            opacity: 0.9;
            line-height: 1.3;
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            margin-top: 4px;
        }

        .entry-count {
            position: absolute;
            top: 6px;
            right: 6px;
            background: #e53e3e;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 11px;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        /* Right Panel - Journal Integration */
        .journal-panel {
            width: 420px;
            background: linear-gradient(135deg, #f8fafc, #edf2f7);
            display: flex;
            flex-direction: column;
            border-left: 2px solid #e2e8f0;
        }

        .journal-header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 24px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .journal-title {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .selected-date {
            font-size: 14px;
            opacity: 0.9;
            font-weight: 400;
        }

        .journal-content {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
        }

        .journal-entry {
            background: white;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border-left: 5px solid #667eea;
            transition: all 0.3s ease;
        }

        .journal-entry:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }

        .entry-header {
            display: flex;
            align-items: center;
            margin-bottom: 16px;
        }

        .entry-mood {
            font-size: 28px;
            margin-right: 16px;
            background: #f7fafc;
            padding: 12px;
            border-radius: 12px;
        }

        .entry-meta {
            flex: 1;
        }

        .entry-title {
            font-size: 18px;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 6px;
        }

        .entry-time {
            font-size: 13px;
            color: #718096;
            font-weight: 500;
        }

        .entry-text {
            color: #4a5568;
            line-height: 1.7;
            font-size: 15px;
            margin-bottom: 16px;
        }

        .entry-tags {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .entry-tag {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
        }

        .no-entries {
            text-align: center;
            color: #718096;
            padding: 60px 20px;
        }

        .no-entries-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .add-entry-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 16px 32px;
            border-radius: 12px;
            font-weight: 700;
            cursor: pointer;
            margin-top: 20px;
            transition: all 0.3s ease;
            width: 100%;
            font-size: 16px;
        }

        .add-entry-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(102, 126, 234, 0.4);
        }

        /* Year/Month Picker (reusing previous code) */
        .picker-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(8px);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .picker-overlay.active {
            display: flex;
        }

        .picker-content {
            background: white;
            border-radius: 20px;
            padding: 32px;
            max-width: 450px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .picker-header {
            text-align: center;
            margin-bottom: 24px;
        }

        .picker-title {
            font-size: 24px;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 8px;
        }

        .picker-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 24px;
        }

        .picker-item {
            background: #f7fafc;
            border: 2px solid transparent;
            padding: 16px 12px;
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .picker-item:hover {
            background: #edf2f7;
            transform: translateY(-2px);
        }

        .picker-item.selected {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-color: #667eea;
        }

        .picker-item.current {
            border-color: #38a169;
            background: #f0fff4;
        }

        .picker-actions {
            display: flex;
            gap: 16px;
            justify-content: flex-end;
        }

        .picker-btn {
            padding: 12px 24px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
            font-size: 14px;
        }

        .picker-btn.cancel {
            background: #f7fafc;
            color: #4a5568;
        }

        .picker-btn.confirm {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .picker-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .infinite-calendar {
                flex-direction: column;
            }

            .journal-panel {
                width: 100%;
                height: 45%;
                border-left: none;
                border-top: 2px solid #e2e8f0;
            }

            .calendar-panel {
                height: 55%;
            }

            .day-cell {
                min-height: 70px;
                padding: 8px 4px;
            }

            .current-month {
                font-size: 22px;
            }

            .journal-content {
                padding: 16px;
            }

            .nav-controls {
                flex-wrap: wrap;
                gap: 8px;
            }

            .nav-btn {
                font-size: 11px;
                padding: 6px 10px;
            }

            .day-number {
                font-size: 14px;
            }
        }

        /* Performance optimizations */
        .calendar-viewport {
            will-change: scroll-position;
            transform: translateZ(0);
        }

        .day-cell {
            will-change: transform, background-color;
        }

        /* Loading state */
        .loading {
            text-align: center;
            padding: 60px;
            color: #718096;
        }

        .spinner {
            display: inline-block;
            width: 24px;
            height: 24px;
            border: 3px solid #e2e8f0;
            border-radius: 50%;
            border-top-color: #667eea;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Scroll indicator */
        .scroll-indicator {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 12px 20px;
            border-radius: 25px;
            font-size: 13px;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }

        .scroll-indicator.visible {
            opacity: 1;
        }
    </style>
</head>
<body>
    <div class="infinite-calendar">
        <!-- Calendar Panel with Perfect Grid -->
        <div class="calendar-panel">
            <div class="calendar-header">
                <div class="current-month" id="currentMonth" onclick="openPicker('month')">Loading...</div>
                <div class="current-date" id="currentDate"></div>
                
                <div class="nav-controls">
                    <div class="quick-nav">
                        <button class="nav-btn" onclick="navigateMonth(-1)">← Prev</button>
                        <button class="nav-btn" onclick="goToToday()">Today</button>
                        <button class="nav-btn" onclick="navigateMonth(1)">Next →</button>
                    </div>
                    
                    <div class="view-toggle">
                        <button class="toggle-btn active" onclick="openPicker('month')">Month</button>
                        <button class="toggle-btn" onclick="openPicker('year')">Year</button>
                    </div>
                    
                    <div class="quick-nav">
                        <button class="nav-btn" onclick="navigateYear(-1)">‹ Year</button>
                        <button class="nav-btn" onclick="navigateYear(1)">Year ›</button>
                    </div>
                </div>
            </div>
            
            <!-- Perfect Week Headers -->
            <div class="weekdays-header">
                <div class="weekday">Sunday</div>
                <div class="weekday">Monday</div>
                <div class="weekday">Tuesday</div>
                <div class="weekday">Wednesday</div>
                <div class="weekday">Thursday</div>
                <div class="weekday">Friday</div>
                <div class="weekday">Saturday</div>
            </div>
            
            <div class="calendar-viewport" id="calendarViewport">
                <div class="calendar-content" id="calendarContent">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Loading perfect calendar grid...</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Enhanced Journal Panel -->
        <div class="journal-panel">
            <div class="journal-header">
                <div class="journal-title">📖 Journal Entries</div>
                <div class="selected-date" id="selectedDate">Select a date to view entries</div>
            </div>
            
            <div class="journal-content" id="journalContent">
                <div class="no-entries">
                    <div class="no-entries-icon">📝</div>
                    <h3>Your Journal Awaits</h3>
                    <p>Click on any date to view or add journal entries</p>
                    <p style="margin-top: 12px; font-size: 13px; opacity: 0.8;">💚 Green days have existing entries</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Year/Month Picker -->
    <div class="picker-overlay" id="pickerOverlay">
        <div class="picker-content">
            <div class="picker-header">
                <div class="picker-title" id="pickerTitle">Select Month</div>
                <div id="pickerSubtitle"></div>
            </div>
            
            <div class="picker-grid" id="pickerGrid">
                <!-- Will be populated by JavaScript -->
            </div>
            
            <div class="picker-actions">
                <button class="picker-btn cancel" onclick="closePicker()">Cancel</button>
                <button class="picker-btn confirm" onclick="confirmPicker()">Go to Date</button>
            </div>
        </div>
    </div>

    <div class="scroll-indicator" id="scrollIndicator">
        📅 Infinite scrolling through perfectly aligned months...
    </div>

    <script>
        // Enhanced journal database with rich sample data
        const journalDatabase = {};
        
        // Calendar state
        let currentViewDate = new Date();
        let selectedDate = null;
        let monthsCache = {};
        let isScrolling = false;
        let scrollTimeout = null;
        let pickerMode = 'month';
        let selectedPickerValue = null;
        
        // Generate comprehensive sample journal entries
        function generateSampleEntries() {
            const moods = ['😊', '🤔', '😌', '🎉', '😔', '🤗', '💪', '🌟', '📚', '☕', '🎨', '🌸', '🔥', '💡', '🎯'];
            const titles = [
                'Morning Reflections', 'Creative Breakthrough', 'Mindful Moments', 'Learning Journey',
                'Gratitude Practice', 'Adventure Time', 'Deep Thoughts', 'Productive Day',
                'Peaceful Evening', 'New Discoveries', 'Goal Progress', 'Random Musings',
                'Life Lessons', 'Simple Joys', 'Future Planning', 'Memory Lane',
                'Inspiration Found', 'Challenge Accepted', 'Wellness Check', 'Dream Analysis',
                'Book Insights', 'Nature Walk', 'Family Time', 'Self Care', 'Work Reflections'
            ];
            
            const contents = [
                'Today I realized the importance of taking time for reflection and mindfulness. These quiet moments help me center myself.',
                'Had an incredible breakthrough in my project. Sometimes the best solutions come when we least expect them.',
                'Spent time in nature and felt deeply connected to the world around me. The fresh air cleared my mind completely.',
                'Learning something new every day keeps life exciting and meaningful. Knowledge is truly a gift we give ourselves.',
                'Practicing gratitude has shifted my perspective in the most beautiful way. Focusing on abundance rather than lack.',
                'Every adventure, big or small, teaches us something about ourselves and the world we live in.',
                'Sometimes the deepest thoughts come in the quietest moments. Silence has its own wisdom to share.',
                'Productivity isn\'t about doing more, it\'s about doing what truly matters and makes a difference.',
                'Ending the day with peace and contentment is a blessing. Tomorrow brings new opportunities.',
                'Discovery happens when we stay curious and open to new experiences. Wonder is everywhere.',
                'Progress isn\'t always linear, but every step forward counts toward our bigger goals.',
                'Random thoughts often lead to the most interesting insights and creative breakthroughs.',
                'Life lessons come in unexpected packages and moments. Staying open to learning is key.',
                'Finding joy in simple things makes every day special and worth celebrating.',
                'Planning for the future while staying present in the moment creates perfect balance.',
                'Memories are the treasures we carry with us always. They shape who we become.',
                'Inspiration can strike anywhere, anytime. The key is staying ready and receptive.',
                'Every challenge is an opportunity to grow stronger, wiser, and more resilient.',
                'Taking care of our physical and mental health should always be a top priority.',
                'Dreams often reveal deeper truths about our desires, fears, and aspirations.'
            ];
            
            const tags = ['personal', 'work', 'health', 'creativity', 'relationships', 'goals', 'learning', 'travel', 'mindfulness', 'growth'];
            
            // Generate entries for past year and future month
            const today = new Date();
            for (let i = -365; i <= 30; i++) {
                const date = new Date(today);
                date.setDate(today.getDate() + i);
                const dateKey = formatDateKey(date);
                
                // 35% chance of having 1-4 entries per day
                if (Math.random() < 0.35) {
                    const numEntries = Math.floor(Math.random() * 4) + 1;
                    journalDatabase[dateKey] = [];
                    
                    for (let j = 0; j < numEntries; j++) {
                        const hour = 7 + Math.floor(Math.random() * 15); // 7 AM to 10 PM
                        const minute = Math.floor(Math.random() * 60);
                        const entryTime = new Date(date);
                        entryTime.setHours(hour, minute, 0, 0);
                        
                        journalDatabase[dateKey].push({
                            id: `${dateKey}-${j}`,
                            title: titles[Math.floor(Math.random() * titles.length)],
                            content: contents[Math.floor(Math.random() * contents.length)],
                            mood: moods[Math.floor(Math.random() * moods.length)],
                            time: entryTime,
                            created: entryTime,
                            tags: [tags[Math.floor(Math.random() * tags.length)]]
                        });
                    }
                    
                    // Sort entries by time
                    journalDatabase[dateKey].sort((a, b) => a.time - b.time);
                }
            }
        }
        
        // Utility functions
        function formatDateKey(date) {
            return date.toISOString().split('T')[0];
        }
        
        function formatDisplayDate(date) {
            return date.toLocaleDateString('en-US', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
        }
        
        function formatMonthYear(date) {
            return date.toLocaleDateString('en-US', { 
                month: 'long', 
                year: 'numeric' 
            });
        }
        
        function getMonthKey(date) {
            return `${date.getFullYear()}-${date.getMonth()}`;
        }
        
        // PERFECT CALENDAR GRID GENERATION - Always 6 weeks, properly aligned
        function generateCalendarDays(year, month) {
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            
            // Start from the Sunday of the week containing the first day
            const startDate = new Date(firstDay);
            startDate.setDate(firstDay.getDate() - firstDay.getDay());
            
            const days = [];
            const currentDate = new Date(startDate);
            
            // Always generate exactly 6 weeks (42 days) for perfect grid alignment
            for (let day = 0; day < 42; day++) {
                const dateKey = formatDateKey(currentDate);
                const entries = journalDatabase[dateKey] || [];
                
                days.push({
                    date: new Date(currentDate),
                    dateKey: dateKey,
                    dayNumber: currentDate.getDate(),
                    isCurrentMonth: currentDate.getMonth() === month,
                    isToday: formatDateKey(currentDate) === formatDateKey(new Date()),
                    hasEntries: entries.length > 0,
                    entryCount: entries.length,
                    entries: entries
                });
                
                currentDate.setDate(currentDate.getDate() + 1);
            }
            
            return days;
        }
        
        function createMonthElement(year, month) {
            const monthDate = new Date(year, month, 1);
            const monthKey = getMonthKey(monthDate);
            
            if (monthsCache[monthKey]) {
                return monthsCache[monthKey];
            }
            
            const monthDiv = document.createElement('div');
            monthDiv.className = 'month-block';
            monthDiv.dataset.month = monthKey;
            
            const monthHeader = document.createElement('div');
            monthHeader.className = 'month-header';
            monthHeader.textContent = formatMonthYear(monthDate);
            
            const daysGrid = document.createElement('div');
            daysGrid.className = 'days-grid';
            
            const days = generateCalendarDays(year, month);
            days.forEach(day => {
                const dayCell = document.createElement('div');
                dayCell.className = `day-cell ${!day.isCurrentMonth ? 'other-month' : ''} ${day.isToday ? 'today' : ''} ${day.hasEntries ? 'has-entry' : ''}`;
                dayCell.dataset.date = day.dateKey;
                
                dayCell.innerHTML = `
                    <div class="day-number">${day.dayNumber}</div>
                    ${day.hasEntries ? `
                        <div class="entry-preview">${day.entries[0].title}</div>
                        ${day.entryCount > 1 ? `<div class="entry-count">${day.entryCount}</div>` : ''}
                    ` : ''}
                `;
                
                dayCell.addEventListener('click', () => selectDate(day.date, day.entries));
                daysGrid.appendChild(dayCell);
            });
            
            monthDiv.appendChild(monthHeader);
            monthDiv.appendChild(daysGrid);
            
            monthsCache[monthKey] = monthDiv;
            return monthDiv;
        }
        
        // Navigation functions
        function navigateMonth(direction) {
            const newDate = new Date(currentViewDate);
            newDate.setMonth(currentViewDate.getMonth() + direction);
            goToDate(newDate);
        }
        
        function navigateYear(direction) {
            const newDate = new Date(currentViewDate);
            newDate.setFullYear(currentViewDate.getFullYear() + direction);
            goToDate(newDate);
        }
        
        function goToToday() {
            goToDate(new Date());
        }
        
        function goToDate(targetDate) {
            currentViewDate = new Date(targetDate);
            updateHeader(currentViewDate);
            
            // Clear cache and regenerate calendar
            monthsCache = {};
            renderCalendar();
            
            // Scroll to the target month
            setTimeout(() => {
                const monthKey = getMonthKey(targetDate);
                const monthElement = document.querySelector(`[data-month="${monthKey}"]`);
                if (monthElement) {
                    monthElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }, 100);
        }
        
        // Picker functions (same as before but enhanced)
        function openPicker(mode) {
            pickerMode = mode;
            const overlay = document.getElementById('pickerOverlay');
            const title = document.getElementById('pickerTitle');
            const subtitle = document.getElementById('pickerSubtitle');
            
            overlay.classList.add('active');
            
            if (mode === 'month') {
                title.textContent = 'Select Month';
                subtitle.textContent = currentViewDate.getFullYear();
                renderMonthPicker();
            } else {
                title.textContent = 'Select Year';
                subtitle.textContent = 'Choose a year to navigate to';
                renderYearPicker();
            }
        }
        
        function renderMonthPicker() {
            const grid = document.getElementById('pickerGrid');
            const months = [
                'January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'
            ];
            
            const currentMonth = currentViewDate.getMonth();
            const todayMonth = new Date().getMonth();
            const todayYear = new Date().getFullYear();
            const currentYear = currentViewDate.getFullYear();
            
            grid.innerHTML = months.map((month, index) => {
                const isSelected = index === currentMonth;
                const isCurrent = index === todayMonth && currentYear === todayYear;
                
                return `
                    <div class="picker-item ${isSelected ? 'selected' : ''} ${isCurrent ? 'current' : ''}" 
                         onclick="selectPickerItem(${index})">
                        ${month}
                    </div>
                `;
            }).join('');
            
            selectedPickerValue = currentMonth;
        }
        
        function renderYearPicker() {
            const grid = document.getElementById('pickerGrid');
            const currentYear = currentViewDate.getFullYear();
            const todayYear = new Date().getFullYear();
            
            // Show 12 years around current year
            const startYear = currentYear - 6;
            const years = [];
            
            for (let i = 0; i < 12; i++) {
                years.push(startYear + i);
            }
            
            grid.innerHTML = years.map(year => {
                const isSelected = year === currentYear;
                const isCurrent = year === todayYear;
                
                return `
                    <div class="picker-item ${isSelected ? 'selected' : ''} ${isCurrent ? 'current' : ''}" 
                         onclick="selectPickerItem(${year})">
                        ${year}
                    </div>
                `;
            }).join('');
            
            selectedPickerValue = currentYear;
        }
        
        function selectPickerItem(value) {
            selectedPickerValue = value;
            
            // Update selected state
            document.querySelectorAll('.picker-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            event.target.classList.add('selected');
        }
        
        function confirmPicker() {
            if (selectedPickerValue === null) return;
            
            let targetDate = new Date(currentViewDate);
            
            if (pickerMode === 'month') {
                targetDate.setMonth(selectedPickerValue);
            } else {
                targetDate.setFullYear(selectedPickerValue);
            }
            
            goToDate(targetDate);
            closePicker();
        }
        
        function closePicker() {
            document.getElementById('pickerOverlay').classList.remove('active');
            selectedPickerValue = null;
        }
        
        // Infinite scrolling implementation
        function renderCalendar() {
            const calendarContent = document.getElementById('calendarContent');
            calendarContent.innerHTML = '';
            
            // Render 30 months (15 past + current + 14 future) for smoother scrolling
            const startDate = new Date(currentViewDate);
            startDate.setMonth(startDate.getMonth() - 15);
            
            for (let i = 0; i < 30; i++) {
                const monthDate = new Date(startDate);
                monthDate.setMonth(startDate.getMonth() + i);
                
                const monthElement = createMonthElement(monthDate.getFullYear(), monthDate.getMonth());
                calendarContent.appendChild(monthElement);
            }
            
            updateHeader(currentViewDate);
        }
        
        function updateHeader(date) {
            document.getElementById('currentMonth').textContent = formatMonthYear(date);
            document.getElementById('currentDate').textContent = formatDisplayDate(new Date());
        }
        
        // Enhanced scroll handling
        function handleScroll() {
            const viewport = document.getElementById('calendarViewport');
            const content = document.getElementById('calendarContent');
            const scrollTop = viewport.scrollTop;
            const scrollHeight = content.scrollHeight;
            const clientHeight = viewport.clientHeight;
            
            // Show scroll indicator
            const indicator = document.getElementById('scrollIndicator');
            if (!isScrolling) {
                indicator.classList.add('visible');
                isScrolling = true;
            }
            
            clearTimeout(scrollTimeout);
            scrollTimeout = setTimeout(() => {
                indicator.classList.remove('visible');
                isScrolling = false;
            }, 1500);
            
            // Find current visible month
            const monthElements = content.querySelectorAll('.month-block');
            let visibleMonth = null;
            
            monthElements.forEach(monthEl => {
                const rect = monthEl.getBoundingClientRect();
                const viewportRect = viewport.getBoundingClientRect();
                
                if (rect.top <= viewportRect.top + 150 && rect.bottom >= viewportRect.top + 150) {
                    visibleMonth = monthEl.dataset.month;
                }
            });
            
            if (visibleMonth) {
                const [year, month] = visibleMonth.split('-');
                const monthDate = new Date(parseInt(year), parseInt(month), 1);
                currentViewDate = monthDate;
                updateHeader(monthDate);
            }
            
            // Load more months if needed
            if (scrollTop < 800) {
                loadMoreMonths('past');
            } else if (scrollTop > scrollHeight - clientHeight - 800) {
                loadMoreMonths('future');
            }
        }
        
        function loadMoreMonths(direction) {
            const content = document.getElementById('calendarContent');
            const firstMonth = content.querySelector('.month-block');
            const lastMonth = content.querySelector('.month-block:last-child');
            
            if (direction === 'past' && firstMonth) {
                const [year, month] = firstMonth.dataset.month.split('-');
                const prevMonth = new Date(parseInt(year), parseInt(month) - 1, 1);
                
                for (let i = 6; i >= 1; i--) {
                    const monthDate = new Date(prevMonth);
                    monthDate.setMonth(prevMonth.getMonth() - i);
                    const monthElement = createMonthElement(monthDate.getFullYear(), monthDate.getMonth());
                    content.insertBefore(monthElement, firstMonth);
                }
            } else if (direction === 'future' && lastMonth) {
                const [year, month] = lastMonth.dataset.month.split('-');
                const nextMonth = new Date(parseInt(year), parseInt(month) + 1, 1);
                
                for (let i = 1; i <= 6; i++) {
                    const monthDate = new Date(nextMonth);
                    monthDate.setMonth(nextMonth.getMonth() + i - 1);
                    const monthElement = createMonthElement(monthDate.getFullYear(), monthDate.getMonth());
                    content.appendChild(monthElement);
                }
            }
        }
        
        // Enhanced journal functions
        function selectDate(date, entries) {
            selectedDate = date;
            
            // Update selected date display
            document.getElementById('selectedDate').textContent = formatDisplayDate(date);
            
            // Render journal entries
            renderJournalEntries(entries);
            
            // Highlight selected day
            document.querySelectorAll('.day-cell').forEach(cell => {
                cell.classList.remove('selected');
            });
            
            const selectedCell = document.querySelector(`[data-date="${formatDateKey(date)}"]`);
            if (selectedCell) {
                selectedCell.classList.add('selected');
            }
        }
        
        function renderJournalEntries(entries) {
            const journalContent = document.getElementById('journalContent');
            
            if (!entries || entries.length === 0) {
                journalContent.innerHTML = `
                    <div class="no-entries">
                        <div class="no-entries-icon">📝</div>
                        <h3>No entries yet</h3>
                        <p>Start your journaling journey for this date</p>
                        <button class="add-entry-btn" onclick="addNewEntry()">✏️ Add Journal Entry</button>
                    </div>
                `;
                return;
            }
            
            journalContent.innerHTML = entries.map(entry => `
                <div class="journal-entry">
                    <div class="entry-header">
                        <div class="entry-mood">${entry.mood}</div>
                        <div class="entry-meta">
                            <div class="entry-title">${entry.title}</div>
                            <div class="entry-time">${entry.time.toLocaleTimeString('en-US', { 
                                hour: 'numeric', 
                                minute: '2-digit', 
                                hour12: true 
                            })}</div>
                        </div>
                    </div>
                    <div class="entry-text">${entry.content}</div>
                    <div class="entry-tags">
                        ${entry.tags.map(tag => `<span class="entry-tag">${tag}</span>`).join('')}
                    </div>
                </div>
            `).join('') + `
                <button class="add-entry-btn" onclick="addNewEntry()">✏️ Add Another Entry</button>
            `;
        }
        
        function addNewEntry() {
            if (!selectedDate) {
                alert('Please select a date first');
                return;
            }
            
            const title = prompt('Entry title:') || 'Untitled Entry';
            const content = prompt('Entry content:') || '';
            const mood = prompt('Mood emoji (😊, 🤔, 😌, etc.):') || '😊';
            
            if (content) {
                const dateKey = formatDateKey(selectedDate);
                if (!journalDatabase[dateKey]) {
                    journalDatabase[dateKey] = [];
                }
                
                const newEntry = {
                    id: `${dateKey}-${Date.now()}`,
                    title: title,
                    content: content,
                    mood: mood,
                    time: new Date(),
                    created: new Date(),
                    tags: ['personal']
                };
                
                journalDatabase[dateKey].push(newEntry);
                journalDatabase[dateKey].sort((a, b) => a.time - b.time);
                
                // Refresh the calendar and journal display
                monthsCache = {}; // Clear cache to regenerate with new entry
                renderCalendar();
                selectDate(selectedDate, journalDatabase[dateKey]);
            }
        }
        
        // Event listeners
        document.getElementById('pickerOverlay').addEventListener('click', function(e) {
            if (e.target === this) {
                closePicker();
            }
        });
        
        // Enhanced keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closePicker();
            } else if (e.key === 'ArrowLeft' && e.ctrlKey) {
                e.preventDefault();
                navigateMonth(-1);
            } else if (e.key === 'ArrowRight' && e.ctrlKey) {
                e.preventDefault();
                navigateMonth(1);
            } else if (e.key === 'ArrowUp' && e.ctrlKey) {
                e.preventDefault();
                navigateYear(-1);
            } else if (e.key === 'ArrowDown' && e.ctrlKey) {
                e.preventDefault();
                navigateYear(1);
            } else if (e.key === 't' && e.ctrlKey) {
                e.preventDefault();
                goToToday();
            } else if (e.key === 'm' && e.ctrlKey) {
                e.preventDefault();
                openPicker('month');
            } else if (e.key === 'y' && e.ctrlKey) {
                e.preventDefault();
                openPicker('year');
            }
        });
        
        // Initialize the perfect calendar
        function initCalendar() {
            console.log('🚀 Initializing Perfect Infinite Calendar...');
            generateSampleEntries();
            renderCalendar();
            
            const viewport = document.getElementById('calendarViewport');
            viewport.addEventListener('scroll', handleScroll, { passive: true });
            
            // Scroll to current month with perfect alignment
            setTimeout(() => {
                const todayElement = document.querySelector('.today');
                if (todayElement) {
                    const monthElement = todayElement.closest('.month-block');
                    if (monthElement) {
                        monthElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                }
            }, 200);
            
            console.log('✅ Perfect Calendar initialized successfully!');
            console.log('🎯 Features: Perfect grid alignment, infinite scroll, journal integration');
            console.log('⌨️ Shortcuts: Ctrl+←→ (months), Ctrl+↑↓ (years), Ctrl+T (today), Ctrl+M (month picker), Ctrl+Y (year picker)');
        }
        
        // Start the perfect calendar
        document.addEventListener('DOMContentLoaded', initCalendar);
    </script>
</body>
</html>
